'''
Created on 23rd April
@Sun Tianchen
'''

'''
{'socialTag': [{'name': '112th United States Congress', 'importance': '2'}, {'name': 'Fiscal conservatism', 'importance': '2'}, {'name': 'Bush tax cuts', 'importance': '2'}, {'name': 'Paul Ryan', 'importance': '1'}, {'name': 'Fiscal policy', 'importance': '1'}, {'name': 'The Path to Prosperity', 'importance': '1'}, {'name': 'United States House of Representatives', 'importance': '2'}, {'name': 'Presidency of Barack Obama', 'importance': '2'}, {'name': 'Republican Party', 'importance': '2'}, {'name': 'Mitt Romney', 'importance': '2'}, {'name': 'United States fiscal cliff', 'importance': '2'}], 'entity': [{'relevance': 0.2, 'type': 'Position', 'name': 'Republican House majority leader'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Jay Carney', 'persontype': 'political', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Position', 'name': 'unanimously rejected president'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Barack Obama', 'persontype': 'political', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Position', 'name': 'President'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'Congress', 'organizationtype': 'governmental civilian', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'Medicare', 'organizationtype': 'governmental civilian', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Eric Cantor', 'persontype': 'N/A', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'House of Representatives', 'organizationtype': 'governmental civilian', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'Senate', 'organizationtype': 'governmental civilian', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'IndustryTerm', 'name': 'oil'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Paul Ryan', 'persontype': 'N/A', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Position', 'name': 'politician'}, {'relevance': 0.2, 'type': 'PoliticalEvent', 'name': 'House vote'}, {'relevance': 0.2, 'type': 'Position', 'name': 'press secretary'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'White House', 'organizationtype': 'governmental civilian', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Mitt Romney', 'persontype': 'sports', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'PoliticalEvent', 'name': 'congressional elections'}, {'relevance': 0.2, 'type': 'IndustryTerm', 'name': 'clean energy programmes'}], 'location': [{'relevance': 0.2, 'type': 'Country', 'longitude': -98.7372244786, 'name': 'United States', 'latitude': 40.4230003233}, {'relevance': 0.2, 'type': 'Continent', 'name': 'America'}, {'relevance': 0.2, 'type': 'City', 'longitude': -77.03, 'latitude': 38.89, 'name': 'Washington', 'containedbycountry': 'United States'}], 'topic': [{'name': 'Business_Finance', 'score': 0.907}, {'name': 'Politics', 'score': 1}, {'name': 'Social Issues', 'score': 0.987}]}

{'socialTag': [{'name': 'Pratt–Romney family', 'importance': '1'}, {'name': 'George W. Romney', 'importance': '1'}, {'name': 'Mitt Romney', 'importance': '1'}, {'name': 'Political positions of Mitt Romney', 'importance': '2'}, {'name': 'Romney', 'importance': '2'}, {'name': 'Mitt Romney presidential campaign', 'importance': '2'}, {'name': 'Rick Santorum', 'importance': '2'}], 'entity': [{'relevance': 0.2, 'type': 'Position', 'name': 'Republican candidate'}, {'relevance': 0.2, 'type': 'IndustryTerm', 'name': 'healthcare anniversary'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Edward Kennedy', 'persontype': 'N/A', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Anniversary', 'name': 'the sixth anniversary of the ceremony'}, {'relevance': 0.2, 'type': 'Facility', 'name': 'Beacon Hill'}, {'relevance': 0.2, 'type': 'IndustryTerm', 'name': 'healthcare bill'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Ted Kennedy', 'persontype': 'sports', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Position', 'name': 'Governor'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Rick Santorum', 'persontype': 'N/A', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'IndustryTerm', 'name': 'reviled national healthcare law'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Hillary Clinton', 'persontype': 'N/A', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'PoliticalEvent', 'name': 'Republican primary race'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'Republican Party', 'organizationtype': 'political party', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'NaturalFeature', 'name': 'Mount Rushmore'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'White House', 'organizationtype': 'governmental civilian', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'PoliticalEvent', 'name': 'Rick Santorum dropped out'}, {'relevance': 0.2, 'type': 'Position', 'name': 'Senator'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Barack Obama', 'persontype': 'N/A', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Position', 'name': 'president'}, {'relevance': 0.8, 'type': 'Person', 'name': 'Mitt Romney', 'persontype': 'N/A', 'nationality': 'American'}, {'relevance': 0.2, 'type': 'IndustryTerm', 'name': 'healthcare cake'}, {'relevance': 0.2, 'type': 'PoliticalEvent', 'name': 'race'}, {'relevance': 0.2, 'type': 'PoliticalEvent', 'name': 'primary races'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Nancy Pelosi', 'persontype': 'N/A', 'nationality': 'N/A'}], 'location': [{'relevance': 0.8, 'type': 'ProvinceOrState', 'longitude': -71.8, 'latitude': 42.3, 'name': 'Massachusetts', 'containedbycountry': 'United States'}, {'relevance': 0.2, 'type': 'City', 'longitude': -77.03, 'latitude': 38.89, 'name': 'Washington', 'containedbycountry': 'United States'}], 'topic': [{'name': 'Politics', 'score': 1}]}
'''

from math import pow

class infoSim:
	'''
	compute pair-wise similarity(distance) of information tags of two news articles
	location, entity, social_tag topic, concept, word(?)
	'''
	def __init__(self):
		self.A = {}
		self.B = {}

	def load(self,a,b):
		self.A = a
		self.B = b

	def weighted_jaccard(self,a_list,b_list):
		#[(name,weight,..),...}
		a_list.sort(key=lambda info: info[0])
		b_list.sort(key=lambda info: info[0])
		i = 0
		j = 0
		nomi = 0
		deno = 0
		while i < len(a_list) and j < len(b_list):
			if a_list[i][0] < b_list[j][0]: #min of a < min of b
				deno += a_list[i][1] #plus weight (relevance)
				i += 1
				continue
			if a_list[i][0] == b_list[j][0]:
				nomi += min(a_list[i][1],b_list[j][1])
				deno += max(a_list[i][1],b_list[j][1])
				i += 1
				j += 1
				continue
			if a_list[i][0] > b_list[j][0]:
				deno += b_list[j][1]
				j += 1
				continue
		if deno == 0:
			return 0
		else:
			return float(nomi/deno)

	def rank_exponent(self,num,degree):
		nomi = []
		for i in range(1,num+1)[::-1]:
			nomi.append(pow(i,degree))
		deno = sum(nomi)
		return [n/deno for n in nomi]
		
	def location(self):
		'''
		Total: City, ProvinceOrState, Country, Region, Continent

		City-City, ProvinceOrState-ProvinceOrState
		City-ProvinceOrState, City-City(containedbystate), Country-Country
		City-City(containedbycountry), ProvinceOrState-ProvinceOrState(containedbycountry), City-Country, City-ProvinceOrState(containedbycountry), Country-ProvinceOrState
		Region-Region, Continent-Continent
		all else pair-wise relations are ingnored

		use Rank Exponent to convert rank into weight(?)
		'''
		rank = self.rank_exponent(num=4,degree=3)
		'''
		4:	[0.7231638418079096, 0.2288135593220339, 0.04519774011299435, 0.002824858757062147]
		3:	[0.64, 0.27, 0.08, 0.01]
		2:	[0.5333333333333333, 0.3, 0.13333333333333333, 0.03333333333333333]
		1:	[0.4, 0.3, 0.2, 0.1]
		'''
		score = 0
		for i in self.A["location"]:
			for j in self.B["location"]:
				if i["type"] < j["type"]:
					a = i
					b = j
				else:
					a = j
					b = i
				relation = (a["type"],b["type"])
				if relation == ("City","City"):
					if a["name"] == b["name"]:
						score += rank[0]
					elif "containedbystate" in a and "containedbystate" in b and a["containedbystate"] == b["containedbystate"]:
						score += rank[1]
					elif "containedbycountry" in a and "containedbycountry" in b and a["containedbycountry"] == b["containedbycountry"]:
						score += rank[2]
				elif relation == ("City","ProvinceOrState"):
					if "containedbystate" in a and a["containedbystate"] == b["name"]:
						score += rank[1]
					elif "containedbycountry" in a and "containedbycountry" in b and a["containedbycountry"] == b["containedbycountry"]:
						score += rank[2]
				elif relation == ("City","Country"):
					if "containedbycountry" in a and a["containedbycountry"] == b["name"]:
						score += rank[2]
				elif relation == ("ProvinceOrState","ProvinceOrState"):
					if a["name"] == b["name"]:
						score += rank[0]
					elif "containedbycountry" in a and "containedbycountry" in b and a["containedbycountry"] == b["containedbycountry"]:
						score += rank[2]
				elif relation == ("Country","ProvinceOrState"):
					if "containedbycountry" in b and a["name"] == b["containedbycountry"]:
						score += rank[2]
				elif relation == ("Country","Country"):
					if a["name"] == b["name"]:
						score += rank[1]
				elif relation == ("Region","Region"):
					if a["name"] == b["name"]:
						score += rank[3]
				elif relation == ("Continent","Continent"):
					if a["name"] == b["name"]:
						score += rank[3]
		return score



	def entity(self):
		'''
		entity
			-type
				-name
		ignore the type, using weighted Jaccard similarity where relevance serves as the weight
		
		[(name,relevance,type,detailtype),...}
		'''
		a_list = []
		b_list = []
		for item in self.A["entity"]:
			if item["type"] == "Organization":
				a_list.append((item["name"],item["relevance"],item["type"]))
			elif item["type"] == "Person":
				a_list.append((item["name"],item["relevance"],item["type"]))
		for item in self.B["entity"]:
			if item["type"] == "Organization":
				b_list.append((item["name"],item["relevance"],item["type"]))
			elif item["type"] == "Person":
				b_list.append((item["name"],item["relevance"],item["type"]))
		return self.weighted_jaccard(a_list,b_list)

	def topic(self):
		a_list = []
		b_list = []
		for item in self.A["topic"]:
			a_list.append((item["name"],item["score"]))
		for item in self.B["topic"]:
			b_list.append((item["name"],item["score"]))
		return self.weighted_jaccard(a_list,b_list)

	def social_tag(self):
		'''
		importance 1 --> weight 3
		importance 2 --> weight 2
		importance 3 --> weight 1
		'''
		a_list = []
		b_list = []
		for item in self.A["socialTag"]:
			a_list.append((item["name"],4-int(item["importance"])))
		for item in self.B["socialTag"]:
			b_list.append((item["name"],4-int(item["importance"])))
		return self.weighted_jaccard(a_list,b_list)


if __name__ == '__main__':
	a = {'socialTag': [{'name': '112th United States Congress', 'importance': '2'}, {'name': 'Fiscal conservatism', 'importance': '2'}, {'name': 'Bush tax cuts', 'importance': '2'}, {'name': 'Paul Ryan', 'importance': '1'}, {'name': 'Fiscal policy', 'importance': '1'}, {'name': 'The Path to Prosperity', 'importance': '1'}, {'name': 'United States House of Representatives', 'importance': '2'}, {'name': 'Presidency of Barack Obama', 'importance': '2'}, {'name': 'Republican Party', 'importance': '2'}, {'name': 'Mitt Romney', 'importance': '2'}, {'name': 'United States fiscal cliff', 'importance': '2'}], 'entity': [{'relevance': 0.2, 'type': 'Position', 'name': 'Republican House majority leader'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Jay Carney', 'persontype': 'political', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Position', 'name': 'unanimously rejected president'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Barack Obama', 'persontype': 'political', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Position', 'name': 'President'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'Congress', 'organizationtype': 'governmental civilian', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'Medicare', 'organizationtype': 'governmental civilian', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Eric Cantor', 'persontype': 'N/A', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'House of Representatives', 'organizationtype': 'governmental civilian', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'Senate', 'organizationtype': 'governmental civilian', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'IndustryTerm', 'name': 'oil'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Paul Ryan', 'persontype': 'N/A', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Position', 'name': 'politician'}, {'relevance': 0.2, 'type': 'PoliticalEvent', 'name': 'House vote'}, {'relevance': 0.2, 'type': 'Position', 'name': 'press secretary'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'White House', 'organizationtype': 'governmental civilian', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Mitt Romney', 'persontype': 'sports', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'PoliticalEvent', 'name': 'congressional elections'}, {'relevance': 0.2, 'type': 'IndustryTerm', 'name': 'clean energy programmes'}], 'location': [{'relevance': 0.2, 'type': 'Country', 'longitude': -98.7372244786, 'name': 'United States', 'latitude': 40.4230003233}, {'relevance': 0.2, 'type': 'Continent', 'name': 'America'}, {'relevance': 0.2, 'type': 'City', 'longitude': -77.03, 'latitude': 38.89, 'name': 'Washington', 'containedbycountry': 'United States'}], 'topic': [{'name': 'Business_Finance', 'score': 0.907}, {'name': 'Politics', 'score': 1}, {'name': 'Social Issues', 'score': 0.987}]}
	b = {'socialTag': [{'name': 'Pratt–Romney family', 'importance': '1'}, {'name': 'George W. Romney', 'importance': '1'}, {'name': 'Mitt Romney', 'importance': '1'}, {'name': 'Political positions of Mitt Romney', 'importance': '2'}, {'name': 'Romney', 'importance': '2'}, {'name': 'Mitt Romney presidential campaign', 'importance': '2'}, {'name': 'Rick Santorum', 'importance': '2'}], 'entity': [{'relevance': 0.2, 'type': 'Position', 'name': 'Republican candidate'}, {'relevance': 0.2, 'type': 'IndustryTerm', 'name': 'healthcare anniversary'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Edward Kennedy', 'persontype': 'N/A', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Anniversary', 'name': 'the sixth anniversary of the ceremony'}, {'relevance': 0.2, 'type': 'Facility', 'name': 'Beacon Hill'}, {'relevance': 0.2, 'type': 'IndustryTerm', 'name': 'healthcare bill'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Ted Kennedy', 'persontype': 'sports', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Position', 'name': 'Governor'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Rick Santorum', 'persontype': 'N/A', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'IndustryTerm', 'name': 'reviled national healthcare law'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Hillary Clinton', 'persontype': 'N/A', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'PoliticalEvent', 'name': 'Republican primary race'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'Republican Party', 'organizationtype': 'political party', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'NaturalFeature', 'name': 'Mount Rushmore'}, {'relevance': 0.2, 'type': 'Organization', 'name': 'White House', 'organizationtype': 'governmental civilian', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'PoliticalEvent', 'name': 'Rick Santorum dropped out'}, {'relevance': 0.2, 'type': 'Position', 'name': 'Senator'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Barack Obama', 'persontype': 'N/A', 'nationality': 'N/A'}, {'relevance': 0.2, 'type': 'Position', 'name': 'president'}, {'relevance': 0.8, 'type': 'Person', 'name': 'Mitt Romney', 'persontype': 'N/A', 'nationality': 'American'}, {'relevance': 0.2, 'type': 'IndustryTerm', 'name': 'healthcare cake'}, {'relevance': 0.2, 'type': 'PoliticalEvent', 'name': 'race'}, {'relevance': 0.2, 'type': 'PoliticalEvent', 'name': 'primary races'}, {'relevance': 0.2, 'type': 'Person', 'name': 'Nancy Pelosi', 'persontype': 'N/A', 'nationality': 'N/A'}], 'location': [{'relevance': 0.8, 'type': 'ProvinceOrState', 'longitude': -71.8, 'latitude': 42.3, 'name': 'Massachusetts', 'containedbycountry': 'United States'}, {'relevance': 0.2, 'type': 'City', 'longitude': -77.03, 'latitude': 38.89, 'name': 'Washington', 'containedbycountry': 'United States'}], 'topic': [{'name': 'Politics', 'score': 1}]}
	info = infoSim()
	info.load(a,b)
	print(info.entity())
	print(info.social_tag())
	print(info.location())
	print(info.topic())